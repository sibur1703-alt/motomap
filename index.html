<!DOCTYPE html>
<html>
<head>
    <title>Moto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .moto-marker { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.4); }
        .leaflet-div-icon { background: transparent; border: none; }
        .ride-icon { font-size: 28px; text-shadow: 0 0 10px #FF5722; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .info-card h3 { margin: 0 0 5px 0; font-size: 16px; }
        .info-card p { margin: 2px 0; font-size: 13px; color: #444; }
        .info-btn { width: 100%; padding: 8px; margin-top: 10px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const map = L.map('map').setView([55.7558, 37.6173], 10);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);

    const pilotsLayer = L.layerGroup().addTo(map);
    const passengersLayer = L.layerGroup().addTo(map);
    const ridesLayer = L.layerGroup().addTo(map);

    const overlays = {
        "üèç –ü–∏–ª–æ—Ç—ã": pilotsLayer,
        "üéí –î–≤–æ–π–∫–∏": passengersLayer,
        "üî• –ü—Ä–æ—Ö–≤–∞—Ç—ã": ridesLayer
    };
    L.control.layers(null, overlays, {collapsed: false}).addTo(map);

    map.locate({setView: true, maxZoom: 14});
    map.on('locationfound', function(e) {
        L.marker(e.latlng).addTo(map).bindPopup("üìç –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –∑–¥–µ—Å—å!").openPopup();
        L.circle(e.latlng, e.accuracy / 2).addTo(map);
    });

    const urlParams = new URLSearchParams(window.location.search);
    const encodedData = urlParams.get('data');
    const mode = urlParams.get('mode'); 
    
    let dataObj = {users: [], rides: []};
    if (encodedData) {
        try { dataObj = JSON.parse(decodeURIComponent(escape(atob(encodedData)))); } 
        catch (e) { console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö", e); }
    }

    dataObj.users.forEach(user => {
        const isPilot = user.role === 'pilot';
        const markerColor = isPilot ? '#1E88E5' : '#E53935';
        
        const customIcon = L.divIcon({
            html: `<div class='moto-marker' style='background-color: ${markerColor};'></div>`,
            className: 'leaflet-div-icon', iconSize: [24, 24], iconAnchor: [12, 12]
        });

        let details = "";
        if (isPilot) {
            details += `<p><b>–ú–æ—Ç:</b> ${user.moto_info || '?'}</p>`;
        } else {
            details += `<p><b>–†–æ—Å—Ç/–í–µ—Å:</b> ${user.height || '?'}/${user.weight || '?'}</p>`;
            details += `<p><b>–≠–∫–∏–ø:</b> ${user.has_gear || '?'}</p>`;
        }
        details += `<p><b>–ò—â–µ—Ç:</b> ${user.preferences || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>`;
        details += `<p><b>–û —Å–µ–±–µ:</b> ${user.bio || ''}</p>`;

        const popupHTML = `
            <div class="info-card" style="min-width: 160px;">
                <h3 style="color: ${markerColor};">${user.name}</h3>
                <p><b>–†–µ–π—Ç–∏–Ω–≥:</b> ‚≠êÔ∏è ${user.rating || 0}</p>
                ${details}
                <button class="info-btn" style="background-color: ${markerColor};" onclick="inviteUser(${user.user_id})">
                    –ü–æ–∑–≤–∞—Ç—å –∫–∞—Ç–∞—Ç—å—Å—è
                </button>
            </div>
        `;

        const marker = L.marker([user.lat, user.lon], {icon: customIcon}).bindPopup(popupHTML);
        
        if (isPilot) { pilotsLayer.addLayer(marker); } 
        else { passengersLayer.addLayer(marker); }
    });

    dataObj.rides.forEach(ride => {
        const rideIcon = L.divIcon({
            html: `<div class='ride-icon'>üî•</div>`,
            className: 'leaflet-div-icon', iconSize: [30, 30], iconAnchor: [15, 15]
        });
        const popupHTML = `
            <div class="info-card" style="text-align: center; min-width: 150px;">
                <h3 style="color: #E65100;">${ride.title}</h3>
                <p>üìÖ ${ride.ride_time} | üìà ${ride.tempo}</p>
                <p style="color: gray;">–û—Ä–≥: ${ride.creator_name}</p>
                <p>üë• <b>–£–∂–µ –µ–¥—É—Ç: ${ride.participants_count || 0}</b></p>
                <button class="info-btn" style="background-color: #FF9800;" onclick="joinRide(${ride.id})">
                    ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
        `;
        const marker = L.marker([ride.lat, ride.lon], {icon: rideIcon}).bindPopup(popupHTML);
        ridesLayer.addLayer(marker);
    });

    window.joinRide = function(rideId) {
        tg.sendData(JSON.stringify({ action: 'join_ride', ride_id: rideId })); tg.close();
    };
    window.inviteUser = function(userId) {
        tg.sendData(JSON.stringify({ action: 'invite_from_map', target_id: userId })); tg.close();
    };

    map.on('click', function(e) {
        if (mode === 'create_ride') {
            tg.sendData(JSON.stringify({ action: 'create_ride_location', lat: e.latlng.lat, lon: e.latlng.lng }));
        } else {
            tg.sendData(JSON.stringify({ action: 'set_location', lat: e.latlng.lat, lon: e.latlng.lng }));
        }
        tg.close(); 
    });
</script>
</body>
</html>
