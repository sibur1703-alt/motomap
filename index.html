<!DOCTYPE html>
<html>
<head>
    <title>Moto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* –ö—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ—Ç–æ—Ü–∏–∫–ª–∏—Å—Ç–æ–≤ */
        .moto-marker {
            background-color: #e53935;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.4);
        }
        
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ú–æ—Å–∫–≤–∞, –µ—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –¥–∞—Å—Ç –¥–æ—Å—Ç—É–ø –∫ GPS)
    const map = L.map('map').setView([55.7558, 37.6173], 10);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // --- –ù–ê–•–û–î–ò–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
    // –ü—Ä–æ—Å–∏–º –±—Ä–∞—É–∑–µ—Ä/—Ç–µ–ª–µ–≥—Ä–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é –∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å –∫–∞—Ä—Ç—É (maxZoom: 14)
    map.locate({setView: true, maxZoom: 14});

    // –ï—Å–ª–∏ –ª–æ–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –Ω–∞–π–¥–µ–Ω–∞:
    map.on('locationfound', function(e) {
        // –°—Ç–∞–≤–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∏–Ω–∏–π –º–∞—Ä–∫–µ—Ä
        L.marker(e.latlng).addTo(map)
            .bindPopup("üìç –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –∑–¥–µ—Å—å!").openPopup();
        
        // –†–∏—Å—É–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∫—Ä—É–≥ —Ç–æ—á–Ω–æ—Å—Ç–∏ GPS
        L.circle(e.latlng, e.accuracy / 2).addTo(map);
    });

    // –ï—Å–ª–∏ —é–∑–µ—Ä –∑–∞–ø—Ä–µ—Ç–∏–ª –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏
    map.on('locationerror', function(e) {
        console.log("–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
        tg.showAlert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–µ–±—è –Ω–∞ –∫–∞—Ä—Ç–µ!");
    });

    // --- –ú–ê–ì–ò–Ø: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–æ–≤ ---
    const urlParams = new URLSearchParams(window.location.search);
    const encodedData = urlParams.get('data');
    
    let users = [];
    if (encodedData) {
        try {
            users = JSON.parse(decodeURIComponent(escape(atob(encodedData))));
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö", e);
        }
    }

    // –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏—Ö –±–∞–π–∫–µ—Ä–æ–≤ (–∫—Ä–∞—Å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã)
    users.forEach(user => {
        const customIcon = L.divIcon({
            html: "<div class='moto-marker'></div>",
            className: 'leaflet-div-icon',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        L.marker([user.lat, user.lon], {icon: customIcon})
            .bindPopup(`<h3>${user.name}</h3><p>–†–æ–ª—å: ${user.role}</p>`)
            .addTo(map);
    });

    // --- –û–¢–ü–†–ê–í–ö–ê –ù–û–í–´–• –ö–û–û–†–î–ò–ù–ê–¢ ---
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        tg.sendData(JSON.stringify({action: 'set_location', lat: lat, lon: lng}));
        tg.close(); 
    });
</script>
</body>
</html>
