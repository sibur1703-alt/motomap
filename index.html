<!DOCTYPE html>
<html>
<head>
    <title>Moto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .moto-marker { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.4); }
        .leaflet-div-icon { background: transparent; border: none; }
        .ride-icon { font-size: 28px; text-shadow: 0 0 10px #FF5722; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const map = L.map('map').setView([55.7558, 37.6173], 10);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);

    const urlParams = new URLSearchParams(window.location.search);
    const encodedData = urlParams.get('data');
    const mode = urlParams.get('mode'); // –ï—Å–ª–∏ mode === 'create_ride', –º–µ–Ω—è–µ–º –ª–æ–≥–∏–∫—É –∫–ª–∏–∫–∞
    
    let dataObj = {users: [], rides: []};
    if (encodedData) {
        try {
            dataObj = JSON.parse(decodeURIComponent(escape(atob(encodedData))));
        } catch (e) { console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö", e); }
    }

    // --- –†–ê–°–°–¢–ê–í–õ–Ø–ï–ú –Æ–ó–ï–†–û–í ---
    dataObj.users.forEach(user => {
        const markerColor = user.role === 'pilot' ? '#1E88E5' : '#E53935';
        const customIcon = L.divIcon({
            html: `<div class='moto-marker' style='background-color: ${markerColor};'></div>`,
            className: 'leaflet-div-icon', iconSize: [24, 24], iconAnchor: [12, 12]
        });
        L.marker([user.lat, user.lon], {icon: customIcon})
            .bindPopup(`<b>${user.name}</b><br><button onclick="inviteUser(${user.user_id})">–ü–æ–∑–≤–∞—Ç—å</button>`)
            .addTo(map);
    });

    // --- –†–ê–°–°–¢–ê–í–õ–Ø–ï–ú –ü–†–û–•–í–ê–¢–´ (–û–ì–û–ù–¨–ö–ò) ---
    dataObj.rides.forEach(ride => {
        const rideIcon = L.divIcon({
            html: `<div class='ride-icon'>üî•</div>`,
            className: 'leaflet-div-icon', iconSize: [30, 30], iconAnchor: [15, 15]
        });
        const popupHTML = `
            <div style="text-align: center; min-width: 150px;">
                <h3 style="margin: 0 0 5px 0; color: #E65100;">${ride.title}</h3>
                <p style="margin: 0;">üìÖ ${ride.ride_time}</p>
                <p style="margin: 0;">üìà –¢–µ–º–ø: ${ride.tempo}</p>
                <p style="margin: 0; font-size: 12px; color: gray;">–û—Ä–≥: ${ride.creator_name}</p>
                <button onclick="joinRide(${ride.id})" style="margin-top: 10px; width: 100%; padding: 8px; background-color: #FF9800; color: white; border: none; border-radius: 6px; font-weight: bold;">
                    ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
        `;
        L.marker([ride.lat, ride.lon], {icon: rideIcon}).bindPopup(popupHTML).addTo(map);
    });

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ---
    window.joinRide = function(rideId) {
        tg.sendData(JSON.stringify({ action: 'join_ride', ride_id: rideId }));
        tg.close();
    };
    window.inviteUser = function(userId) {
        tg.sendData(JSON.stringify({ action: 'invite_from_map', target_id: userId }));
        tg.close();
    };

    // --- –ö–õ–ò–ö –ü–û –ö–ê–†–¢–ï ---
    map.on('click', function(e) {
        if (mode === 'create_ride') {
            // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ö–≤–∞—Ç–∞
            tg.sendData(JSON.stringify({ action: 'create_ride_location', lat: e.latlng.lat, lon: e.latlng.lng }));
        } else {
            // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º (–æ–±–Ω–æ–≤–∏—Ç—å —Å–µ–±—è)
            tg.sendData(JSON.stringify({ action: 'set_location', lat: e.latlng.lat, lon: e.latlng.lng }));
        }
        tg.close(); 
    });
</script>
</body>
</html>
