<!DOCTYPE html>
<html>
<head>
    <title>Moto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* –ö—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ—Ç–æ—Ü–∏–∫–ª–∏—Å—Ç–æ–≤ */
        .moto-marker {
            background-color: #e53935;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.4);
        }
        
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ú–æ—Å–∫–≤–∞)
    const map = L.map('map').setView([55.7558, 37.6173], 10);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // --- –ù–ê–•–û–î–ò–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
    map.locate({setView: true, maxZoom: 14});

    map.on('locationfound', function(e) {
        L.marker(e.latlng).addTo(map)
            .bindPopup("üìç –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –∑–¥–µ—Å—å!").openPopup();
        L.circle(e.latlng, e.accuracy / 2).addTo(map);
    });

    map.on('locationerror', function(e) {
        console.log("–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω.");
        tg.showAlert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–µ–±—è –Ω–∞ –∫–∞—Ä—Ç–µ!");
    });

    // --- –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –Æ–ó–ï–†–û–í –ò–ó –°–°–´–õ–ö–ò ---
    const urlParams = new URLSearchParams(window.location.search);
    const encodedData = urlParams.get('data');
    
    let users = [];
    if (encodedData) {
        try {
            users = JSON.parse(decodeURIComponent(escape(atob(encodedData))));
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö", e);
        }
    }

    // --- –†–ê–°–°–¢–ê–í–õ–Ø–ï–ú –î–†–£–ì–ò–• –ë–ê–ô–ö–ï–†–û–í –ò –ö–ù–û–ü–ö–£ "–ü–û–ó–í–ê–¢–¨" ---
    users.forEach(user => {
        const customIcon = L.divIcon({
            html: "<div class='moto-marker'></div>",
            className: 'leaflet-div-icon',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // HTML –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞
        const popupHTML = `
            <div style="text-align: center; min-width: 140px;">
                <h3 style="margin: 0 0 5px 0;">${user.name}</h3>
                <p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">–†–æ–ª—å: ${user.role}</p>
                <button onclick="sendInvite(${user.user_id}, '${user.username || ''}')" 
                        style="width: 100%; padding: 8px; background-color: #e53935; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    üèç –ü–æ–∑–≤–∞—Ç—å
                </button>
            </div>
        `;

        L.marker([user.lat, user.lon], {icon: customIcon})
            .bindPopup(popupHTML)
            .addTo(map);
    });

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò –ò–ù–í–ê–ô–¢–ê ---
    window.sendInvite = function(targetId, targetUsername) {
        tg.sendData(JSON.stringify({
            action: 'invite_from_map', 
            target_id: targetId,
            target_username: targetUsername
        }));
        tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    };

    // --- –û–¢–ü–†–ê–í–ö–ê –°–í–û–ò–• –ö–û–û–†–î–ò–ù–ê–¢ (–ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ) ---
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        tg.sendData(JSON.stringify({
            action: 'set_location', 
            lat: lat, 
            lon: lng
        }));
        tg.close(); 
    });
</script>
</body>
</html>
