<!DOCTYPE html>
<html>
<head>
    <title>Moto Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .moto-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.4);
        }
        
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const map = L.map('map').setView([55.7558, 37.6173], 10);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // --- –ù–ê–•–û–î–ò–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
    map.locate({setView: true, maxZoom: 14});

    map.on('locationfound', function(e) {
        L.marker(e.latlng).addTo(map).bindPopup("üìç –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –∑–¥–µ—Å—å!").openPopup();
        L.circle(e.latlng, e.accuracy / 2).addTo(map);
    });

    map.on('locationerror', function(e) {
        tg.showAlert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–µ–±—è –Ω–∞ –∫–∞—Ä—Ç–µ!");
    });

    // --- –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –Æ–ó–ï–†–û–í –ò–ó –°–°–´–õ–ö–ò ---
    const urlParams = new URLSearchParams(window.location.search);
    const encodedData = urlParams.get('data');
    
    let users = [];
    if (encodedData) {
        try {
            users = JSON.parse(decodeURIComponent(escape(atob(encodedData))));
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö", e);
        }
    }

    // --- –†–ê–°–°–¢–ê–í–õ–Ø–ï–ú –ë–ê–ô–ö–ï–†–û–í ---
    users.forEach(user => {
        // –ï—Å–ª–∏ –ø–∏–ª–æ—Ç - —Å–∏–Ω–∏–π —Ü–≤–µ—Ç (#1E88E5), –µ—Å–ª–∏ –¥–≤–æ–π–∫–∞ - —Ä–æ–∑–æ–≤—ã–π/–∫—Ä–∞—Å–Ω—ã–π (#E53935)
        const markerColor = user.role === 'pilot' ? '#1E88E5' : '#E53935';
        const roleText = user.role === 'pilot' ? 'üèç –ü–∏–ª–æ—Ç' : 'üéí –î–≤–æ–π–∫–∞';

        const customIcon = L.divIcon({
            html: `<div class='moto-marker' style='background-color: ${markerColor};'></div>`,
            className: 'leaflet-div-icon',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        const popupHTML = `
            <div style="text-align: center; min-width: 140px;">
                <h3 style="margin: 0 0 5px 0;">${user.name}</h3>
                <p style="margin: 0 0 10px 0; font-size: 13px; font-weight: bold; color: ${markerColor};">${roleText}</p>
                <button onclick="sendInvite(${user.user_id}, '${user.username || ''}')" 
                        style="width: 100%; padding: 8px; background-color: ${markerColor}; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    –ü–æ–∑–≤–∞—Ç—å –ø–æ–∫–∞—Ç–∞—Ç—å—Å—è
                </button>
            </div>
        `;

        L.marker([user.lat, user.lon], {icon: customIcon})
            .bindPopup(popupHTML)
            .addTo(map);
    });

    window.sendInvite = function(targetId, targetUsername) {
        tg.sendData(JSON.stringify({
            action: 'invite_from_map', 
            target_id: targetId,
            target_username: targetUsername
        }));
        tg.close();
    };

    map.on('click', function(e) {
        tg.sendData(JSON.stringify({
            action: 'set_location', lat: e.latlng.lat, lon: e.latlng.lng
        }));
        tg.close(); 
    });
</script>
</body>
</html>
